# PM2 éƒ¨ç½²æŒ‡å—

## ğŸš€ é¡¹ç›®å¯åŠ¨æ–¹å¼

### å¼€å‘ç¯å¢ƒ

```bash
# å¯åŠ¨APIæœåŠ¡ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
npm run dev

# å¯åŠ¨å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
npm run scheduler:dev

# æˆ–è€…åˆ†åˆ«åœ¨ä¸¤ä¸ªç»ˆç«¯çª—å£è¿è¡Œï¼š
# ç»ˆç«¯1: npm run dev
# ç»ˆç«¯2: npm run scheduler:dev
```

### ç”Ÿäº§ç¯å¢ƒ

#### æ–¹å¼1ï¼šä½¿ç”¨PM2ï¼ˆæ¨èï¼‰

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
npm run pm2:start:prod

# æŸ¥çœ‹çŠ¶æ€
npm run pm2:status

# æŸ¥çœ‹æ—¥å¿—
npm run pm2:logs

# ç›‘æ§é¢æ¿
npm run pm2:monit

# é‡å¯æ‰€æœ‰æœåŠ¡
npm run pm2:restart

# åœæ­¢æ‰€æœ‰æœåŠ¡
npm run pm2:stop

# åˆ é™¤æ‰€æœ‰æœåŠ¡
npm run pm2:delete
```

#### æ–¹å¼2ï¼šæ‰‹åŠ¨å¯åŠ¨

```bash
# å¯åŠ¨APIæœåŠ¡
npm start

# å¯åŠ¨å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆæ–°ç»ˆç«¯ï¼‰
npm run scheduler
```

## ğŸ“Š PM2åº”ç”¨è¯´æ˜

### åº”ç”¨åˆ—è¡¨
- **zhimai-api**: ä¸»APIæœåŠ¡
- **zhimai-scheduler**: å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨

### å®šæ—¶ä»»åŠ¡è¯´æ˜
| ä»»åŠ¡ | é¢‘ç‡ | è¯´æ˜ |
|------|------|------|
| æ´»åŠ¨çŠ¶æ€æ›´æ–° | æ¯å°æ—¶ | è‡ªåŠ¨æ›´æ–°æ´»åŠ¨çŠ¶æ€ï¼ˆæœªå¼€å§‹â†’è¿›è¡Œä¸­â†’å·²ç»“æŸï¼‰ |
| æé†’æ£€æŸ¥ | æ¯5åˆ†é’Ÿ | æ£€æŸ¥å¹¶å‘é€æ´»åŠ¨æé†’æ¶ˆæ¯ |
| Tokenæ¸…ç† | æ¯å¤©2ç‚¹ | æ¸…ç†è¿‡æœŸçš„ç®¡ç†å‘˜Token |
| æ•°æ®åº“å¤‡ä»½ | æ¯å¤©3ç‚¹ | æ•°æ®åº“å¤‡ä»½ï¼ˆéœ€è¦é…ç½®ï¼‰ |

## ğŸ“ æ—¥å¿—æ–‡ä»¶

PM2ä¼šè‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹æ—¥å¿—æ–‡ä»¶ï¼š
```
logs/
â”œâ”€â”€ api-error.log      # APIé”™è¯¯æ—¥å¿—
â”œâ”€â”€ api-out.log        # APIè¾“å‡ºæ—¥å¿—
â”œâ”€â”€ api-combined.log   # APIç»¼åˆæ—¥å¿—
â”œâ”€â”€ scheduler-error.log    # è°ƒåº¦å™¨é”™è¯¯æ—¥å¿—
â”œâ”€â”€ scheduler-out.log      # è°ƒåº¦å™¨è¾“å‡ºæ—¥å¿—
â””â”€â”€ scheduler-combined.log # è°ƒåº¦å™¨ç»¼åˆæ—¥å¿—
```

## ğŸ”§ å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹ç‰¹å®šåº”ç”¨çŠ¶æ€
pm2 show zhimai-api
pm2 show zhimai-scheduler

# é‡å¯ç‰¹å®šåº”ç”¨
pm2 restart zhimai-api
pm2 restart zhimai-scheduler

# æŸ¥çœ‹ç‰¹å®šåº”ç”¨æ—¥å¿—
pm2 logs zhimai-api
pm2 logs zhimai-scheduler

# å®æ—¶ç›‘æ§
pm2 monit

# ä¿å­˜å½“å‰PM2é…ç½®
pm2 save

# è®¾ç½®PM2å¼€æœºè‡ªå¯
pm2 startup
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç«¯å£å†²çª**: ç¡®ä¿3000ç«¯å£æœªè¢«å ç”¨
2. **ç¯å¢ƒå˜é‡**: ç¡®ä¿.envæ–‡ä»¶é…ç½®æ­£ç¡®
3. **æ•°æ®åº“è¿æ¥**: ç¡®ä¿MySQLå’ŒRedisæœåŠ¡æ­£å¸¸è¿è¡Œ
4. **æ—¥å¿—è½®è½¬**: å»ºè®®é…ç½®æ—¥å¿—è½®è½¬ï¼Œé¿å…æ—¥å¿—æ–‡ä»¶è¿‡å¤§
5. **å†…å­˜ç›‘æ§**: å·²é…ç½®1GBå†…å­˜é™åˆ¶ï¼Œè¶…å‡ºä¼šè‡ªåŠ¨é‡å¯

## ğŸ› ï¸ æ•…éšœæ’é™¤

### APIæœåŠ¡æ— æ³•å¯åŠ¨
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -an | findstr :3000

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
npm run test

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
npm run pm2:logs
```

### å®šæ—¶ä»»åŠ¡ä¸æ‰§è¡Œ
```bash
# æ£€æŸ¥è°ƒåº¦å™¨çŠ¶æ€
pm2 show zhimai-scheduler

# æŸ¥çœ‹è°ƒåº¦å™¨æ—¥å¿—
pm2 logs zhimai-scheduler

# æ‰‹åŠ¨æ‰§è¡Œå•ä¸ªä»»åŠ¡æµ‹è¯•
npm run update-status
npm run check-reminders
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å¯ç”¨é›†ç¾¤æ¨¡å¼**ï¼ˆé«˜å¹¶å‘åœºæ™¯ï¼‰ï¼š
   ```javascript
   // ecosystem.config.js
   instances: 'max', // æˆ–å…·ä½“æ•°å­—
   exec_mode: 'cluster'
   ```

2. **é…ç½®è´Ÿè½½å‡è¡¡**ï¼ˆå¤šæœåŠ¡å™¨éƒ¨ç½²ï¼‰
3. **ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢**
4. **é…ç½®Redisç¼“å­˜**
5. **å¯ç”¨gzipå‹ç¼©**

---

*æœ€åæ›´æ–°: $(date)*
